<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>je pense qu'on a assez joué</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" relstylesheet>
<style>
:root{
  --muted:#6b7280;
  --accent:#ff6b4a;
  --bg:#fffaf0;
  --card:#ffffff;
  --shadow: rgba(16,24,40,0.08);
  --ok:#059669;
  --bad:#b91c1c;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,#fffaf0 0%, #fff6ec 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  -webkit-font-smoothing:antialiased;
}

/* Card */
.card{
  width:100%;
  max-width:880px;
  background:var(--card);
  border-radius:16px;
  padding:20px;
  box-shadow:0 18px 40px var(--shadow);
  border: 1px solid rgba(255,255,255,0.6);
  overflow:visible;
}

/* Header / title */
.header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:8px;
}
.brand-badge{
  width:56px;height:56px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),#ff8d6b);
  display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
  box-shadow:0 6px 18px rgba(255,107,74,0.12);
  font-size:18px;
}
h1{margin:0;font-size:20px;color:#1f2937;font-weight:700}
.lead{color:#374151;margin-top:6px;margin-bottom:12px;line-height:1.45}

/* lock box */
.box{background:#fafafa;padding:14px;border-radius:12px;border:1px solid #f0f0f0;margin-top:12px;display:flex;gap:12px;align-items:center}
.lock{
  width:92px;height:92px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff8f2);
  display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(16,24,40,0.06);
  position:relative; overflow:visible;
  transition: transform .52s cubic-bezier(.2,.9,.3,1), box-shadow .28s;
}
.lock svg{width:60px;height:76px;overflow:visible;display:block}
.lock .shackle{ transform-box: fill-box; transform-origin:50% 26%; transition: transform 480ms cubic-bezier(.2,.9,.3,1), stroke 300ms;}
.lock.open{ transform: translateY(-6px) rotate(-6deg); box-shadow:0 18px 34px rgba(5,150,105,0.08) }
.lock.open .shackle{ transform: rotate(-40deg) translate(8px,-12px); stroke:var(--ok); }
.lock.open rect{ stroke:var(--ok); }

/* status / map */
.status{margin:0;font-weight:700;color:#374151}
.mapnote{color:var(--muted);font-size:13px;margin-top:6px}

/* countdown overlay */
.countdownWrap{
  margin-top:12px;padding:12px;border-radius:10px;background:#fffaf6;border:1px solid #f3e2d9;
  display:flex;align-items:center;gap:12px;justify-content:space-between;
}
.countdownLabel{font-weight:700;color:#92400e}
.countdownTimer{font-size:18px;font-weight:800;color:#ff6b4a}

/* grid for puzzles */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
@media (max-width:760px){ .grid{grid-template-columns:1fr} .lock{margin:0 auto} .card{padding:16px} }

.label{font-size:13px;color:var(--muted);margin-bottom:6px}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6;font-size:16px}
.input::placeholder{font-style:italic;color:#9ca3af}
.btn{
  background:var(--accent); color:white; border:0;padding:12px 16px;border-radius:12px;font-weight:700;
  cursor:pointer; box-shadow:0 8px 24px rgba(16,24,40,0.06);
  transition: transform .12s ease, box-shadow .12s ease;
  font-size:15px;
}
.btn:active{ transform:translateY(2px) scale(.998) }
.btn.ghost{background:transparent;border:1px solid #e6e6e6;color:#333;padding:10px 12px}
.small{padding:8px 10px;font-size:14px;border-radius:10px}
.hint{font-size:13px;color:var(--muted);margin-top:8px}
.message{margin-top:10px;font-weight:700;min-height:22px}
.success{color:var(--ok)}
.error{color:var(--bad)}
.finalBtn{
  display:inline-block;margin-top:16px;padding:14px 20px;border-radius:12px;background:linear-gradient(180deg,var(--ok),#0b7a52);
  color:white;font-weight:800;text-decoration:none;box-shadow:0 10px 30px rgba(5,150,105,0.14);
  transform:translateY(6px);opacity:0;transition:all .36s cubic-bezier(.2,.9,.3,1);
}
.finalBtn.show{transform:none;opacity:1}
.smallNote{font-size:13px;color:var(--muted);margin-top:8px}
.kv{font-weight:700;color:#374151}

/* digit reveal - placed above final input */
.digitsRow{display:flex;gap:12px;margin-top:14px;align-items:center;justify-content:center;flex-wrap:wrap}
.digit{
  width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#fff,#fffcf8);
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:#1f2937;
  box-shadow:0 10px 30px rgba(16,24,40,0.06); transform:scale(.88); opacity:0;
  transition:transform .36s cubic-bezier(.2,.9,.3,1), opacity .36s;
}
.digit.show{transform:scale(1);opacity:1; animation:pop .5s ease;}
@keyframes pop{0%{transform:scale(.6);opacity:0}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}

/* reveal animation */
.reveal{ animation: revealIn .44s cubic-bezier(.2,.9,.3,1) both }
@keyframes revealIn {
  from{opacity:0; transform: translateY(10px) scale(.995)}
  to{opacity:1; transform:none}
}

.fadeOut{animation:fadeOut .32s ease forwards}
@keyframes fadeOut{from{opacity:1;transform:none}to{opacity:0;transform:translateY(-8px) scale(.98)}}

/* video container */
/* Portrait (9:16) responsive container and no black bars */
.videoWrap{margin-top:14px;border-radius:12px;overflow:hidden;background:transparent;display:none;position:relative;padding-top:177.7777778%}
.videoWrap iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;display:block;object-fit:cover}
.videoWrap img#videoThumb{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;cursor:pointer}
.videoWrap .thumbPlay{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.5); color:#fff; border-radius:999px; padding:12px 16px; font-weight:700;
  display:inline-flex; align-items:center; gap:8px; border:0; cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,0.25);
}

/* small translucent play icon circle for mobile */
.videoControls{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}

/* utilities */
.controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
.testBtn{background:#6b7280;padding:10px 12px;border-radius:10px;color:#fff;border:none;font-weight:700}
.note{font-size:13px;color:var(--muted);margin-top:10px}
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <div class="header">
      <div class="brand-badge">✓</div>
      <div>
        <h1 id="title">je pense qu'on a assez joué</h1>
        <div class="lead">Indice de départ : rends-toi à l’endroit où vous avez passé beaucoup de temps pendant les vacances, et souvent mal accompagnés. Une fois sur place, l’épreuve commence.</div>
      </div>
    </div>

    <div class="box lockbox" aria-hidden="false">
      <div class="lock" id="lock" aria-hidden="true">
        <svg viewBox="0 0 24 34" preserveAspectRatio="xMidYMid meet" role="img" aria-hidden="true">
          <rect x="3.5" y="12" width="17" height="10" rx="2" stroke="#ff6b4a" stroke-width="1.6" fill="white"/>
          <g class="shackle">
            <path d="M7 12V8a5 5 0 0 1 10 0v4" stroke="#ff6b4a" stroke-width="1.6" stroke-linecap="round" fill="none"/>
          </g>
        </svg>
      </div>

      <div style="flex:1">
        <div id="geoStatus" class="status">Vérification de la position…</div>
        <div id="dist" class="mapnote"></div>

        <div class="controls">
          <!-- Les boutons de simulation ont été supprimés -->
        </div>
        <div class="note">Le site utilise la géolocalisation — utilise le test si tu veux vérifier sans bouger.</div>
      </div>
    </div>

    <!-- Compte à rebours jusqu'à 19:55 (visible si on est arrivé avant l'heure) -->
    <div id="countdownBox" class="countdownWrap" style="display:none">
      <div>
        <div class="countdownLabel">Épreuves verrouillées</div>
        <div class="mapnote">Les épreuves ne commencent qu'à :</div>
      </div>
      <div style="text-align:right">
        <div class="countdownTimer" id="countdownTimer">19:55:00</div>
        <div style="font-size:12px;color:var(--muted)">Heure locale</div>
      </div>
    </div>

    <div id="puzzles" class="box" style="display:none">
      <h2>Les épreuves</h2>
      <p class="hint">Résous ces 4 défis pour découvrir le code final (chaque épreuve dévoile un chiffre).</p>

      <div class="grid">
        <!-- Épreuve 1 -->
        <div class="reveal">
          <div class="label">il faut un peu reflchir meme si t'es pas tres forte</div>
          <div class="hint">Léna est devant leur enfant, mais derrière Yassine. Qui est au milieu ?</div>
          <input id="ans1" class="input" placeholder="Ecrire ici">
          <div style="margin-top:8px">
            <button id="check1" class="btn small">Valider</button>
            <span id="msg1" class="message" aria-live="polite"></span>
          </div>
        </div>

        <!-- Épreuve 2 -->
        <div class="reveal">
          <div class="label">stp soit pas bete</div>
          <div class="hint">Texte chiffré (Atbash, symétrie a↔z) :</div>
          <div style="background:#fffef6;padding:10px;border-radius:8px;border:1px dashed #f3e2d9;margin-top:6px">
            <code id="cipherText" style="font-weight:700;letter-spacing:1px">gf nv ivmwh svfivfc</code>
          </div>
          <input id="ans2" class="input" placeholder="Ecrire ici">
          <div style="margin-top:8px">
            <button id="check2" class="btn small">Valider</button>
            <span id="msg2" class="message" aria-live="polite"></span>
          </div>
        </div>
      </div>

      <!-- Épreuve 3 & 4 (obligatoires) -->
      <div style="margin-top:14px" class="reveal">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px;background:#fff;padding:12px;border-radius:10px;border:1px solid #f0f0f0">
            <div class="label">Petit exercice d'attention</div>
            <div class="hint">Combien de voyelles y a-t-il dans la phrase : "<strong>bonjour mon amour</strong>" ?</div>
            <input id="ans3" class="input" placeholder="Ecrire ici">
            <div style="margin-top:8px"><button id="check3" class="btn small">Valider</button><span id="msg3" class="message"></span></div>
          </div>

          <div style="flex:1;min-width:220px;background:#fff;padding:12px;border-radius:10px;border:1px solid #f0f0f0">
            <div class="label">Addition lettre → nombre</div>
            <div class="hint">Calcule : L + E + N + A + Y + A + S + S + I + N + E (A=1, B=2, ...). Écris le résultat.</div>
            <input id="ans4" class="input" placeholder="Ecrire ici">
            <div style="margin-top:8px"><button id="check4" class="btn small">Valider</button><span id="msg4" class="message"></span></div>
          </div>
        </div>
      </div>

      <!-- digits fixed row (all digits together, visually above final input) -->
      <div class="digitsRow" id="digitsRow">
        <div id="digit1" class="digit" aria-hidden="true">–</div>
        <div id="digit2" class="digit" aria-hidden="true">–</div>
        <div id="digit3" class="digit" aria-hidden="true">–</div>
        <div id="digit4" class="digit" aria-hidden="true">–</div>
      </div>

      <div style="margin-top:16px" class="reveal">
        <div class="label">Code final</div>
        <div class="hint">Entrez le code final. Les chiffres seront complétés automatiquement quand tu résoudras les épreuves.</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <input id="finalInput" class="input" style="max-width:140px" inputmode="numeric" maxlength="4" placeholder="Ecrire ici">
          <button id="checkFinal" class="btn small">Valider</button>
          <span id="msgFinal" class="message" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <div id="congrats" style="display:none;text-align:center;margin-top:18px">
      <p class="lead">Tu as bien reussis toute les epreuves, profites du moment.</p>

      <div id="videoArea">
        <div class="videoWrap" id="videoWrap" aria-hidden="true"></div>
        <div class="videoControls" id="videoControls" style="display:none">
          <button id="openYT" class="btn small">Ouvrir la vidéo</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ----- CONFIG : le lien Google Drive fourni (video) -----
  const DRIVE_LINK = 'https://drive.google.com/file/d/1dFqndr0AOelhhJAlbnDPlDHPTQ1n7tWi/view?usp=drivesdk';
  const THUMBNAIL_SRC = './joyeux-anniversaire.jpg';

  // cible GPS (la Tour Eiffel selon ton code d'origine)
  const TARGET = { lat: 48.858370, lon: 2.294481 };
  const RADIUS = 40; // mètres pour déclencher arrivée

  // heure minimale pour débuter les épreuves (19:55)
  const START_HOUR = 19;
  const START_MIN = 55;

  let unlocked=false, watchId=null, arrivedAtPlace=false, countdownInterval=null;
  const geoStatus = document.getElementById('geoStatus'), distEl = document.getElementById('dist');
  const lock = document.getElementById('lock'), puzzles = document.getElementById('puzzles');
  const countdownBox = document.getElementById('countdownBox'), countdownTimer = document.getElementById('countdownTimer');

  const ans1 = document.getElementById('ans1'), check1 = document.getElementById('check1'), msg1 = document.getElementById('msg1');
  const ans2 = document.getElementById('ans2'), check2 = document.getElementById('check2'), msg2 = document.getElementById('msg2');
  const ans3 = document.getElementById('ans3'), check3 = document.getElementById('check3'), msg3 = document.getElementById('msg3');
  const ans4 = document.getElementById('ans4'), check4 = document.getElementById('check4'), msg4 = document.getElementById('msg4');

  const digit1El = document.getElementById('digit1'), digit2El = document.getElementById('digit2'),
        digit3El = document.getElementById('digit3'), digit4El = document.getElementById('digit4');

  const finalInput = document.getElementById('finalInput'), checkFinal = document.getElementById('checkFinal'), msgFinal = document.getElementById('msgFinal');
  const congrats = document.getElementById('congrats');

  const videoWrap = document.getElementById('videoWrap'), videoControls = document.getElementById('videoControls'), openYT = document.getElementById('openYT');

  const step2Plain = "tu me rends heureux";
  const digits = ['-','-','-','-'];
  const expectedFinal = '2110';

  // utilitaires
  function toRad(x){return x*Math.PI/180;}
  function distanceMeters(lat1,lon1,lat2,lon2){
    const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function normalizeText(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z'\s]/g,'').replace(/\s+/g,' ').trim(); }

  // met à jour l'input final
  function updateFinalField(){
    finalInput.value = digits.join('');
    digit1El.textContent = digits[0] === '-' ? '–' : digits[0];
    digit2El.textContent = digits[1] === '-' ? '–' : digits[1];
    digit3El.textContent = digits[2] === '-' ? '–' : digits[2];
    digit4El.textContent = digits[3] === '-' ? '–' : digits[3];
    if(digits[0] !== '-') digit1El.classList.add('show');
    if(digits[1] !== '-') digit2El.classList.add('show');
    if(digits[2] !== '-') digit3El.classList.add('show');
    if(digits[3] !== '-') digit4El.classList.add('show');
  }

  // --- GESTION HORAIRE ---
  // retourne Date cible aujourd'hui 19:55 (ou demain si déjà passé)
  function nextStartDate(){
    const now = new Date();
    const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), START_HOUR, START_MIN, 0, 0);
    if(now > target) {
      // si l'heure est déjà passée aujourd'hui, on prend la prochaine journée
      target.setDate(target.getDate() + 1);
    }
    return target;
  }

  function formatTimeLeft(ms){
    if(ms < 0) ms = 0;
    const totalSec = Math.floor(ms/1000);
    const h = Math.floor(totalSec/3600).toString().padStart(2,'0');
    const m = Math.floor((totalSec%3600)/60).toString().padStart(2,'0');
    const s = (totalSec%60).toString().padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  // affiche ou cache la box de countdown
  function showCountdownBox(show){
    if(show) countdownBox.style.display = 'flex';
    else countdownBox.style.display = 'none';
  }

  // démarre le timer visuel jusqu'à 19:55
  function startCountdownVisual(overrideTargetDate){
    if(countdownInterval) clearInterval(countdownInterval);
    const targetDate = overrideTargetDate || nextStartDate();
    showCountdownBox(true);
    countdownInterval = setInterval(()=>{
      const now = new Date();
      const diff = targetDate - now;
      countdownTimer.textContent = formatTimeLeft(diff);
      if(diff <= 0){
        clearInterval(countdownInterval);
        showCountdownBox(false);
        // si déjà arrivé sur place on débloque
        if(arrivedAtPlace && !unlocked){
          revealPuzzlesNow();
        }
      }
    }, 500);
  }

  // --- ARRIVEE / REVELATION ---
  function revealPuzzlesNow(){
    unlocked = true;
    geoStatus.textContent = "Les épreuves sont maintenant accessibles — bonne chance.";
    distEl.style.display = 'none';
    lock.classList.add('open');
    try{ if(navigator.vibrate) navigator.vibrate([200,70,150]); }catch(e){}
    setTimeout(()=>{ puzzles.style.display='block'; puzzles.scrollIntoView({behavior:'smooth', block:'center'}); }, 360);
    try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId); }catch(e){}
  }

  // lorsqu'on arrive sur le lieu
  function arrived(){
    arrivedAtPlace = true;
    const now = new Date();
    const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), START_HOUR, START_MIN, 0, 0);
    // si l'heure est déjà atteinte (>= 19:55) : révéler tout de suite
    if(now >= startToday){
      revealPuzzlesNow();
      return;
    }
    // sinon informer et afficher countdown (et cacher les puzzles si visibles)
    geoStatus.textContent = "Tu es arrivé, mais les épreuves ne commencent qu'à " + START_HOUR + "h" + (START_MIN.toString().padStart(2,'0')) + ".";
    // show countdown toward today's start time
    startCountdownVisual(startToday);
    // ensure puzzles hidden until start
    puzzles.style.display = 'none';
    congrats.style.display = 'none';
  }

  // --- GEOLOCATION ---
  function startWatch(){
    if(!('geolocation' in navigator)){
      geoStatus.textContent = "Géolocalisation non supportée. Utilise le bouton de simulation.";
      return;
    }
    geoStatus.textContent = "Surveillance de la position en cours…";
    watchId = navigator.geolocation.watchPosition(pos=>{
      const d = distanceMeters(pos.coords.latitude, pos.coords.longitude, TARGET.lat, TARGET.lon);
      distEl.textContent = `Distance ≈ ${Math.round(d)} m`;
      if(d <= RADIUS && !unlocked){
        arrived();
      }
    }, err=>{
      geoStatus.textContent = "Autorise la localisation ou utilise le bouton manuel.";
      console.warn('geoloc error', err);
    }, { enableHighAccuracy:true, maximumAge:3000, timeout:20000 });
  }

  // initialisation : démarrer le watch
  startWatch();

  // --- Épreuves (inchangées, uniquement intégrées) ---
  check1.addEventListener('click', ()=>{
    const v = normalizeText(ans1.value);
    if(v === 'lena' || v === 'léna'){
      msg1.textContent = "Correct ✓"; msg1.className='message success';
      ans1.disabled = true; check1.style.display='none';
      digits[0] = '2';
      updateFinalField();
    } else {
      msg1.textContent = "Non — relis l'énoncé."; msg1.className='message error';
    }
  });

  check2.addEventListener('click', ()=>{
    const v = normalizeText(ans2.value);
    if(v === normalizeText(step2Plain)){
      msg2.textContent = "Correct ✓"; msg2.className='message success';
      ans2.disabled = true; check2.style.display='none';
      digits[1] = '1';
      updateFinalField();
    } else {
      msg2.textContent = "Incorrect — réessaie (Atbash)."; msg2.className='message error';
    }
  });

  check3.addEventListener('click', ()=>{
    const v = (ans3.value||'').trim();
    const numeric = parseInt(v,10);
    if(Number.isFinite(numeric) && numeric === 7){
      msg3.textContent = "Correct ✓"; msg3.className='message success';
      ans3.disabled = true; check3.style.display='none';
      digits[2] = '1';
      updateFinalField();
    } else {
      msg3.textContent = "Non — vérifie la phrase et recompte les voyelles." ; msg3.className='message error';
    }
  });

  check4.addEventListener('click', ()=>{
    const v = parseInt((ans4.value||'').trim(),10);
    const expected = 124; // calcul L+E+N+A+Y+A+S+S+I+N+E
    if(Number.isFinite(v) && v === expected){
      msg4.textContent = "Correct ✓"; msg4.className='message success';
      ans4.disabled = true; check4.style.display='none';
      digits[3] = '0';
      updateFinalField();
    } else {
      msg4.textContent = "Non — fais le calcul comme indiqué."; msg4.className='message error';
    }
  });

  checkFinal.addEventListener('click', ()=>{
    const submittedDigits = (finalInput.value||'').replace(/[^\d]/g,'');
    if(submittedDigits.length !== 4){
      msgFinal.textContent = "Le code doit comporter 4 chiffres (les cases se remplissent automatiquement).";
      msgFinal.className='message error';
      return;
    }
    if(submittedDigits === expectedFinal){
      msgFinal.textContent = "Code valide — bravo !"; msgFinal.className='message success';
      try{ if(navigator.vibrate) navigator.vibrate([200,100,200]); }catch(e){}
      puzzles.classList.add('fadeOut');
      setTimeout(()=>{
        puzzles.style.display='none';
        congrats.style.display='block';
        congrats.scrollIntoView({behavior:'smooth', block:'center'});
        showFinalVideo();
      }, 360);
    } else {
      msgFinal.textContent = "Code incorrect."; msgFinal.className='message error';
      if(!msgFinal.dataset.hinted){
        msgFinal.dataset.hinted='1';
        msgFinal.textContent += " (indice : vérifie les 4 chiffres révélés).";
      }
    }
  });

  [ans1,ans2,ans3,ans4,finalInput].forEach(inp=>{
    inp.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        if(inp===ans1) check1.click();
        if(inp===ans2) check2.click();
        if(inp===ans3) check3.click();
        if(inp===ans4) check4.click();
        if(inp===finalInput) checkFinal.click();
      }
    });
  });

  // --- Video / Drive handling (inchangé) ---
  function extractDriveId(url){
    try{
      const u = new URL(url);
      const m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if(m && m[1]) return m[1];
      const idParam = u.searchParams.get('id');
      if(idParam) return idParam;
      const parts = u.pathname.split('/');
      for(let i = parts.length-1;i>=0;i--){
        if(parts[i]) return parts[i];
      }
    }catch(e){
      const m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if(m && m[1]) return m[1];
    }
    return null;
  }

  function createDriveEmbedFromLink(link){
    if(!link) return null;
    const id = extractDriveId(link);
    if(!id) return null;
    const embed = `https://drive.google.com/file/d/${id}/preview`;
    const iframe = document.createElement('iframe');
    iframe.src = embed;
    iframe.title = "Vidéo finale";
    iframe.setAttribute('allow','autoplay; fullscreen; encrypted-media; picture-in-picture');
    iframe.setAttribute('frameborder','0');
    iframe.allowFullscreen = true;
    return { iframe, watchUrl: link };
  }

  function showFinalVideo(){
    try{ if(navigator.vibrate) navigator.vibrate([120,50,120]); }catch(e){}
    videoWrap.innerHTML = '';
    const img = document.createElement('img');
    img.id = 'videoThumb';
    img.alt = 'Miniature vidéo';
    img.src = THUMBNAIL_SRC;
    img.loading = 'lazy';
    img.addEventListener('error', function(){
      videoWrap.innerHTML = '<div class="note" style="padding:12px">Miniature introuvable — la vidéo sera chargée directement.</div>';
      loadDriveIframe();
    });
    videoWrap.appendChild(img);

    const playBtn = document.createElement('button');
    playBtn.type = 'button';
    playBtn.className = 'thumbPlay';
    playBtn.innerHTML = '► Lire';
    playBtn.title = 'Lire la vidéo';
    function onPlayClick(){ loadDriveIframe(); }
    img.addEventListener('click', onPlayClick);
    playBtn.addEventListener('click', onPlayClick);
    videoWrap.appendChild(playBtn);

    videoWrap.style.display = 'block';
    videoControls.style.display = 'none';

    function loadDriveIframe(){
      if(videoWrap.querySelector('iframe')) return;
      const res = createDriveEmbedFromLink(DRIVE_LINK);
      if(!res){
        videoWrap.innerHTML = '<div class="note" style="margin-top:10px">Impossible d’extraire l’ID depuis ce lien Google Drive. Vérifie le lien.</div>';
        return;
      }
      videoWrap.innerHTML = '';
      videoWrap.appendChild(res.iframe);
      videoControls.style.display = 'flex';
      openYT.onclick = ()=> { window.open(res.watchUrl, '_blank', 'noopener'); };
    }
  }

  // initial field state
  updateFinalField();

  // expose for debugging
  window._etape8 = {
    digits,
    arrived: ()=>{ if(!unlocked) { arrived(); } },
    showFinalVideo,
    startCountdownVisual
  };

})();
</script>
</body>
</html>
